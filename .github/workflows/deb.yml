name: Build Debian Package

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v5

      - name: Install build dependencies
        run: |
          sudo apt-get update
          # Install essential Debian packaging tools
          sudo apt-get install -y \
            build-essential devscripts debhelper fakeroot lintian
          sudo apt-get build-dep -y .

      - name: Generate dpkg-changelog entry
        run: |
          export DEBFULLNAME="${{ github.actor }}"
          export DEBEMAIL="${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
          DEB_VERSION=0.$(date +'%Y%m%d').0~git~$(git rev-parse --short HEAD)
          dch -b -v $DEB_VERSION --package git-keeper "Automated build on Github Actions for ${{ github.ref }}"

      - name: Build Debian package
        run: |
          dpkg-buildpackage -us -uc -b

      - name: Run litian
        run: lintian -IE

      - name: Show results
        run: |
          ls -lh ..
          echo "Generated DEB files:"
          ls -lh ../*.deb
          dpkg -I ../*.deb
          dpkg -c ../*.deb
          mv ../*.deb ./

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debian-packages
          path: ./*.deb
